<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <!-- Загружаем наш скрипт с правильным MIME-типом -->
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .payment-box { border: 2px solid #ccc; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .status { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body>
<div class="container">
    <h1>{{.Title}}</h1>

    <div class="payment-box">
        <h3>Выберите способ оплаты:</h3>
        <div id="tbank-payment-container"></div>
    </div>

    <div class="status">
        <h3>Статус:</h3>
        <div id="status-area">Загрузка...</div>
    </div>

    <button onclick="checkStatus()">Проверить статус</button>
</div>

<script>
    // Ждем загрузки DOM
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация с небольшой задержкой для избежания конфликтов
        setTimeout(initializePayment, 500);
    });

    let paymentIntegration;

    function initializePayment() {
        try {
            paymentIntegration = new TBankPaymentIntegration({
                terminalKey: "{{.TerminalKey}}",
                backendUrl: "{{.BackendUrl}}",
                widgetTypes: ['sbp', 'tpay'],
                onSuccess: function(data) {
                    document.getElementById('status-area').innerHTML =
                        '<span style="color: green;">✓ Оплата успешна</span>';
                },
                onError: function(error) {
                    document.getElementById('status-area').innerHTML =
                        '<span style="color: red;">✗ Ошибка: ' + error.message + '</span>';
                }
            });

            // Периодическая проверка инициализации
            const checkInit = setInterval(() => {
                if (paymentIntegration && paymentIntegration.getStatus().initialized) {
                    document.getElementById('status-area').innerHTML =
                        '<span style="color: green;">✓ Интеграция активна</span>';
                    clearInterval(checkInit);
                }
            }, 1000);

        } catch (error) {
            console.error('Initialization error:', error);
            document.getElementById('status-area').innerHTML =
                '<span style="color: red;">✗ Ошибка инициализации: ' + error.message + '</span>';
        }
    }

    function checkStatus() {
        if (paymentIntegration) {
            const status = paymentIntegration.getStatus();
            alert(`Статус интеграции:\n` +
                `Инициализирована: ${status.initialized}\n` +
                `Контейнер: ${status.containerId}\n` +
                `Интеграция: ${status.hasIntegration ? 'да' : 'нет'}`);
        } else {
            alert('Интеграция не инициализирована');
        }
    }
</script>

<script>
    // frontend/include-tbank.js
    /**
     * @file T-Bank Payment Integration Frontend Library
     * @version 1.0.0
     * @license MIT
     */

    class TBankPaymentIntegration {
        /**
         * @typedef {Object} TBankConfig
         * @property {string} terminalKey - Terminal key from T-Bank cabinet
         * @property {string} [containerId='tbank-payment-container'] - ID of DOM container
         * @property {string[]} [widgetTypes=[]] - Array of widget types: 'sbp', 'tpay', 'bnpl', 'sberpay', 'mirpay'
         * @property {string} backendUrl - URL to your backend endpoint
         * @property {Function} [onSuccess] - Callback on successful payment
         * @property {Function} [onError] - Callback on payment error
         * @property {Object} [customStyles] - Custom CSS styles for container
         */

        /**
         * Initialize T-Bank payment integration
         * @param {TBankConfig} config - Configuration object
         */
        constructor(config) {
            this.config = this._validateConfig(config);
            this.integration = null;
            this.container = null;
            this.isInitialized = false;

            // Load T-Bank script dynamically
            this._loadScript();
        }

        /**
         * Validate configuration
         * @private
         * @param {TBankConfig} config
         * @returns {TBankConfig}
         */
        _validateConfig(config) {
            if (!config.terminalKey) {
                throw new Error('terminalKey is required');
            }
            if (!config.backendUrl) {
                throw new Error('backendUrl is required');
            }

            return {
                terminalKey: config.terminalKey,
                containerId: config.containerId || 'tbank-payment-container',
                widgetTypes: config.widgetTypes || [],
                backendUrl: config.backendUrl,
                onSuccess: config.onSuccess || (() => {}),
                onError: config.onError || ((error) => console.error('T-Bank Error:', error)),
                customStyles: config.customStyles || {}
            };
        }

        /**
         * Load T-Bank script
         * @private
         */
        _loadScript() {
            if (window.PaymentIntegration) {
                this._initIntegration();
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://securepayments.tbank.ru/eacq/integration/paymentIntegration.js';
            script.defer = true;
            script.onload = () => this._initIntegration();
            script.onerror = () => this.config.onError(new Error('Failed to load T-Bank script'));

            document.head.appendChild(script);
        }

        /**
         * Initialize T-Bank integration
         * @private
         */
        async _initIntegration() {
            try {
                const initConfig = {
                    terminalKey: this.config.terminalKey,
                    product: 'eacq',
                    features: {
                        payment: {}
                    }
                };

                // Wait for PaymentIntegration to be available
                if (!window.PaymentIntegration) {
                    setTimeout(() => this._initIntegration(), 100);
                    return;
                }

                const integration = await PaymentIntegration.init(initConfig);
                this.integration = integration;

                // Create container if not exists
                this._createContainer();

                // Set up payment callback
                await this._setupPaymentCallback();

                // Create and mount widgets
                await this._createWidgets();

                this.isInitialized = true;
                console.log('T-Bank integration initialized successfully');

            } catch (error) {
                this.config.onError(error);
            }
        }

        /**
         * Create container for payment widgets
         * @private
         */
        _createContainer() {
            let container = document.getElementById(this.config.containerId);

            if (!container) {
                container = document.createElement('div');
                container.id = this.config.containerId;
                container.className = 'tbank-payment-container';
                document.body.appendChild(container);
            }

            // Apply custom styles
            Object.assign(container.style, {
                maxWidth: '400px',
                margin: '20px auto',
                padding: '20px',
                border: '1px solid #e0e0e0',
                borderRadius: '8px',
                backgroundColor: '#fff',
                ...this.config.customStyles
            });

            this.container = container;
        }

        /**
         * Set up payment callback
         * @private
         */
        async _setupPaymentCallback() {
            await this.integration.payments.setPaymentStartCallback(async (paymentType) => {
                try {
                    // Call backend to initiate payment
                    const response = await fetch(this.config.backendUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            paymentType: paymentType,
                            terminalKey: this.config.terminalKey
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Backend error: ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data.paymentUrl) {
                        throw new Error('No paymentUrl received from backend');
                    }

                    return data.paymentUrl;

                } catch (error) {
                    this.config.onError(error);
                    throw error;
                }
            });
        }

        /**
         * Create and mount payment widgets
         * @private
         */
        async _createWidgets() {
            try {
                // Create main integration
                const mainPaymentIntegration = await this.integration.payments.create(
                    'main-integration',
                    {}
                );

                // Set widget types (if specified, otherwise use all available)
                if (this.config.widgetTypes.length > 0) {
                    await mainPaymentIntegration.updateWidgetTypes(this.config.widgetTypes);
                }

                // Mount to container
                await mainPaymentIntegration.mount(this.container);

            } catch (error) {
                this.config.onError(error);
            }
        }

        /**
         * Update payment amount (call before payment)
         * @param {number} amount - Amount in rubles (e.g., 100.50)
         * @param {string} orderId - Your internal order ID
         * @param {string} description - Payment description
         */
        async updatePayment(amount, orderId, description = '') {
            if (!this.isInitialized) {
                throw new Error('Integration not initialized');
            }

            // This would typically be called from your backend
            // For frontend, we just store the data
            this.currentPayment = {
                amount: amount,
                orderId: orderId,
                description: description,
                timestamp: Date.now()
            };

            // You might want to update backend with this info
            await fetch(`${this.config.backendUrl}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderId: orderId,
                    amount: amount,
                    description: description
                })
            });
        }

        /**
         * Destroy integration and clean up
         */
        destroy() {
            if (this.container && this.container.parentNode) {
                this.container.parentNode.removeChild(this.container);
            }
            this.integration = null;
            this.isInitialized = false;
        }

        /**
         * Get current status
         * @returns {Object} Status object
         */
        getStatus() {
            return {
                initialized: this.isInitialized,
                containerId: this.config.containerId,
                widgetTypes: this.config.widgetTypes,
                currentPayment: this.currentPayment || null
            };
        }
    }

    // Global initialization helper
    window.initializeTBank = function(config) {
        return new TBankPaymentIntegration(config);
    };

    // Export for module systems
    if (typeof module !== 'undefined' && module.exports) {
        module.exports = TBankPaymentIntegration;
    }

    // Example CSS styles
    const styles = `
.tbank-payment-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
}

.tbank-payment-container button {
    transition: all 0.3s ease;
}

.tbank-payment-container button:hover {
    opacity: 0.9;
}

.tbank-loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
`;

    // Inject styles
    const styleSheet = document.createElement('style');
    styleSheet.textContent = styles;
    document.head.appendChild(styleSheet);
</script>
</body>
</html>